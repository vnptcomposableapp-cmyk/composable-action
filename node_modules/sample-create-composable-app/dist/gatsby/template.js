"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GATSBY_SSR_CONFIG = exports.GATSBY_404 = void 0;
exports.makeGatsbyDefaultPage = makeGatsbyDefaultPage;
exports.GATSBY_PLUGIN_CONFIG = GATSBY_PLUGIN_CONFIG;
exports.makeGatsbyHostPage = makeGatsbyHostPage;
exports.makeGatsbyPlasmicInit = makeGatsbyPlasmicInit;
exports.wrapAppRootForCodegen = wrapAppRootForCodegen;
const file_utils_1 = require("../utils/file-utils");
function makeGatsbyDefaultPage(jsOrTs) {
    return `import React from "react";
import Helmet from "react-helmet";
import {
  PlasmicComponent,
  PlasmicRootProvider,${(0, file_utils_1.ifTs)(jsOrTs, `
  InitOptions,
  ComponentRenderData,`)}
} from "@plasmicapp/loader-gatsby";
import { graphql${(0, file_utils_1.ifTs)(jsOrTs, ', PageProps')} } from "gatsby";
import { initPlasmicLoaderWithRegistrations } from "../plasmic-init";

export const query = graphql\`
  query ($path: String) {
    plasmicComponents(componentNames: [$path])
    plasmicOptions
  }
\`;

${(0, file_utils_1.ifTs)(jsOrTs, `interface PlasmicGatsbyPageProps extends PageProps {
  data: {
    plasmicOptions: InitOptions
    plasmicComponents: ComponentRenderData
  }
}
`)}
const PlasmicGatsbyPage = ({ data, location }${(0, file_utils_1.ifTs)(jsOrTs, ': PlasmicGatsbyPageProps')}) => {
  const {
    plasmicComponents,
    plasmicOptions,
  } = data;
  const pageMeta = plasmicComponents.entryCompMetas[0];
  const pageMetadata = pageMeta.pageMetadata;
  return (
    <PlasmicRootProvider
      loader={initPlasmicLoaderWithRegistrations(plasmicOptions)}
      prefetchedData={plasmicComponents}
      pageRoute={pageMeta.path}
      pageParams={pageMeta.params}
      pageQuery={Object.fromEntries(new URLSearchParams(location.search))}
      Head={Helmet}
    >
      <Helmet>
        {pageMetadata?.title && <title>{pageMetadata.title}</title>}
        {pageMetadata?.title && <meta property="og:title" content={pageMetadata.title} /> }
        {pageMetadata?.description && <meta property="og:description" content={pageMetadata.description} />}
        {pageMetadata?.openGraphImageUrl && <meta property="og:image" content={pageMetadata.openGraphImageUrl} />}
      </Helmet>
      <PlasmicComponent component={pageMeta.displayName} />
    </PlasmicRootProvider>
  );
};

export default PlasmicGatsbyPage;
`;
}
exports.GATSBY_404 = `const NotFound = () => {
  return "Not Found";
};
export default NotFound;
`;
function GATSBY_PLUGIN_CONFIG(projectId, projectApiToken, jsOrTs) {
    return `{
  resolve: "@plasmicapp/loader-gatsby",
  options: {
    projects: [
      {
        id: "${projectId}",
        token: "${projectApiToken}",
      },
    ], // An array of project ids.
    preview: false,
    defaultPlasmicPage: ${jsOrTs === 'ts' ? 'path' : 'require'}.resolve("./src/templates/defaultPlasmicPage.${jsOrTs}x"),
  },
},
{
  resolve: "gatsby-plugin-react-helmet",
}
`;
}
function makeGatsbyHostPage(opts) {
    const { jsOrTs, scheme } = opts;
    if (scheme === 'loader') {
        return `import * as React from "react"
import {
  PlasmicCanvasHost${(0, file_utils_1.ifTs)(jsOrTs, ', InitOptions')}
} from "@plasmicapp/loader-gatsby"
import { graphql } from "gatsby"
import { initPlasmicLoaderWithRegistrations } from "../plasmic-init"

export const query = graphql\`
  query {
    plasmicOptions
  }
\`

${(0, file_utils_1.ifTs)(jsOrTs, `interface HostProps {
  data: {
    plasmicOptions: InitOptions;
  }
}
`)}
export default function Host({ data }${(0, file_utils_1.ifTs)(jsOrTs, ': HostProps')}) {
  const { plasmicOptions } = data
  initPlasmicLoaderWithRegistrations(plasmicOptions)
  return <PlasmicCanvasHost />
}
`;
    }
    else {
        return `import * as React from "react"
import { PlasmicCanvasHost, registerComponent } from "@plasmicapp/react-web/lib/host";

// You can register any code components that you want to use here; see
// https://docs.plasmic.app/learn/code-components-ref/
// And configure your Plasmic project to use the host url pointing at
// the /plasmic-host page of your nextjs app (for example,
// http://localhost:3000/plasmic-host).  See
// https://docs.plasmic.app/learn/app-hosting/#set-a-plasmic-project-to-use-your-app-host

// registerComponent(...)

export default function PlasmicHost() {
  return (
    <PlasmicCanvasHost />
  );
}
`;
    }
}
exports.GATSBY_SSR_CONFIG = `/**
 * Implement Gatsby's SSR (Server Side Rendering) APIs in this file.
 *
 * See: https://www.gatsbyjs.com/docs/ssr-apis/
 */

const React = require("react")

const HeadComponents = [
  <script
    key="plasmic-hmr"
    type="text/javascript"
    dangerouslySetInnerHTML={{
      __html: \`
        if (typeof window !== "undefined" && /\\\\/plasmic-host\\\\/?$/.test(window.location.pathname)) {
          const RealEventSource = window.EventSource;
          window.EventSource = function(url, config) {
            if (/[^a-zA-Z]hmr($|[^a-zA-Z])/.test(url)) {
              console.warn("Plasmic: disabled EventSource request for", url);
              return {
                onerror() {}, onmessage() {}, onopen() {}, close() {}
              };
            } else {
              return new RealEventSource(url, config);
            }
          }
        }
      \`,
    }}
  />
]

const isProduction = process.env.NODE_ENV === "production"

exports.onRenderBody = ({ pathname, setHeadComponents }) => {
  /**
   * We add the preamble tag script to all pages during development mode
   * because during development all pages are dynamically rendered based
   * on \`/\` route, during production we add it only in \`/plasmic-host/\`
   */
  if (!isProduction || pathname === "/plasmic-host/") {
    setHeadComponents(HeadComponents)
  }
}
`;
function makeGatsbyPlasmicInit(jsOrTs) {
    return `import {
  initPlasmicLoader,${(0, file_utils_1.ifTs)(jsOrTs, `
  InitOptions,`)}
} from "@plasmicapp/loader-gatsby";

export function initPlasmicLoaderWithRegistrations(plasmicOptions${(0, file_utils_1.ifTs)(jsOrTs, ': InitOptions')}) {
  const PLASMIC = initPlasmicLoader(plasmicOptions);

  // You can register any code components that you want to use here; see
  // https://docs.plasmic.app/learn/code-components-ref/
  // And configure your Plasmic project to use the host url pointing at
  // the /plasmic-host page of your nextjs app (for example,
  // http://localhost:8000/plasmic-host).  See
  // https://docs.plasmic.app/learn/app-hosting/#set-a-plasmic-project-to-use-your-app-host

  // PLASMIC.registerComponent(...);

  return PLASMIC;
}
`;
}
function wrapAppRootForCodegen() {
    return `import React from "react";
import { PlasmicRootProvider } from "@plasmicapp/react-web";
import { Link } from "gatsby";
import Helmet from "react-helmet";

export const wrapRootElement = ({ element }) => {
  return (
    <PlasmicRootProvider Head={Helmet} Link={Link}>
      {element}
    </PlasmicRootProvider>
  );
}
`;
}
